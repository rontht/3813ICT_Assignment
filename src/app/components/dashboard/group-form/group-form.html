<div class="flex h-full">
  <aside class="w-[300px] flex flex-col h-full">
    <div class="text-xs">Group Name:</div>

    <div class="text-xl mb-3 pb-5 border-b-2 border-white/10">
      {{ group_name }}
    </div>

    @if (create_new) {
    <h2 class="text-md text-white mb-3">Add Channels</h2>
    } @else {
    <h2 class="text-md text-white mb-3">Editing Channels</h2>
    }
    <nav
      [ngClass]="{
        'max-h-[40vh]': !create_new
      }"
      class="space-y-4 flex-1 overflow-y-auto hide-scrollbar pr-1"
    >
      <div *ngFor="let channel of current_channels" class="relative">
        <div
          class="bg-secondary block w-full text-left px-4 py-4.5 rounded-xl shadow-xl"
        >
          <div class="w-full flex justify-between items-center">
            <p class="truncate"># {{ channel.name }}</p>
            <button
              type="button"
              class="text-center flex items-center px-3 py-2 rounded hover:bg-white/10"
              (click)="moveToDelete(channel)"
            >
              <span class="text-xs">Delete</span>
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Channels to be deleted -->
    @if (!create_new) {
    <h2 class="text-md text-white mb-3 mt-3 pt-3 border-t-2 border-white/10">
      Channels to be delete
    </h2>
    <nav
      class="space-y-4 flex-1 max-h-[25vh] overflow-y-auto hide-scrollbar pr-1"
    >
      <div *ngFor="let channel of channels_to_delete" class="relative">
        <div
          class="bg-secondary block w-full text-left px-4 py-4.5 rounded-xl shadow-xl"
        >
          <div class="w-full flex justify-between items-center">
            <p class="truncate"># {{ channel.name }}</p>
            <button
              type="button"
              class="text-center flex items-center px-3 py-2 rounded hover:bg-white/10"
              (click)="removeFromDelete(channel)"
            >
              <span class="text-xs">Remove</span>
            </button>
          </div>
        </div>
      </div>
    </nav>
    }

    <div class="pt-4 mt-4 border-t-2 border-white/10 relative">
      <!-- Add new channel trigger -->
      <button
        type="button"
        class="w-full px-4 py-3 rounded-xl bg-secondary shadow-xl hover:bg-secondary-hover"
        (click)="toggleAddChannel($event)"
      >
        Add new channel
      </button>

      <!-- Inline popup (like dropdown) -->
      @if (show_add_channel_menu) {
      <div
        class="absolute right-1 bottom-full mb-2 z-10 w-60 rounded-xl border border-white/20 bg-main/95 shadow-2xl p-3"
        (click)="$event.stopPropagation()"
      >
        <input
          type="text"
          [(ngModel)]="new_channel_name"
          placeholder="Channel name"
          class="w-full rounded-md bg-transparent border border-white/20 px-2 py-1 text-sm outline-none focus:border-white/40"
          (keydown.enter)="confirmAddChannel()"
        />
        <button
          type="button"
          class="mt-3 w-full px-3 py-2 rounded-md bg-secondary hover:bg-secondary-hover text-sm"
          (click)="confirmAddChannel()"
        >
          Create
        </button>
      </div>
      }

      <!-- Cancel button below -->
      @if (!create_new) {
      <button
        type="button"
        class="w-full px-4 py-3 mt-4 rounded-xl bg-secondary shadow-xl hover:bg-secondary-hover"
        (click)="cancel(current_group)"
      >
        Cancel
      </button>
      }
    </div>
  </aside>

  <div class="flex w-full h-full justify-center">
    <div class="w-4xl bg-secondary rounded-2xl p-8 shadow-xl">
      @if (create_new) {
      <h2 class="text-2xl font-bold mb-2">Create a Group</h2>
      } @else {
      <h2 class="text-2xl font-bold mb-2">Editing the Group</h2>
      }
      <form class="space-y-10" (ngSubmit)="saveGroup()">
        <div class="flex space-x-5">
          <!-- Name -->
          <div class="flex flex-col w-full">
            <label for="name" class="mb-1 text-sm font-medium text-white"
              >Name</label
            >
            <input
              id="name"
              type="name"
              name="name"
              [(ngModel)]="group_name"
              class="w-full border-b-2 border-white bg-transparent py-2 focus:outline-none focus:border-purple-400"
            />
          </div>
        </div>

        <div class="flex space-x-5">
          <div class="w-[400px] h-[62vh] bg-main rounded-2xl">
            <div
              class="mb-1 text-sm font-medium text-white flex w-full h-[40px]"
            >
              <button
                type="button"
                (click)="changeTab(1)"
                class="w-full rounded-tl-2xl"
                [ngClass]="{
                  'bg-main': select_tab === 1,
                  'bg-main-inactive': select_tab !== 1
                }"
              >
                Non-members
              </button>
              <button
                type="button"
                (click)="changeTab(2)"
                class="w-full rounded-tr-2xl"
                [ngClass]="{
                  'bg-main': select_tab === 2,
                  'bg-main-inactive': select_tab !== 2
                }"
              >
                Requested to join
              </button>
            </div>

            @switch (select_tab) { @case(1) { @if (old_user_array.length > 0) {
            <div class="space-y-3 overflow-auto w-[365px] h-[56vh] m-auto">
              <div
                *ngFor="let u of old_user_array"
                class="flex items-center justify-between p-3 rounded-lg bg-main/70 shadow"
              >
                <div>
                  <p class="font-semibold">
                    {{ u.name }},
                    <span class="font-normal text-sm text-white/70">{{
                      u.username
                    }}</span>
                  </p>
                  <p class="text-sm text-gray-300">{{ u.email }}</p>
                </div>
                <div class="flex gap-2">
                  <button
                    type="button"
                    class="px-2 py-1 w-[100px] bg-blue-800 rounded"
                    (click)="addMember(u)"
                  >
                    Add
                  </button>
                </div>
              </div>
            </div>
            } @else {
            <p class="text-gray-300 p-4">No users found.</p>

            } } @case (2) { @if (requested_array.length > 0) {
            <div class="space-y-3 overflow-auto w-[365px] h-[56vh] m-auto">
              <div
                *ngFor="let u of requested_array"
                class="flex items-center justify-between p-3 rounded-lg bg-main/70 shadow"
              >
                <div>
                  <p class="font-semibold">
                    {{ u.name }},
                    <span class="font-normal text-sm text-white/70">{{
                      u.username
                    }}</span>
                  </p>
                  <p class="text-sm text-gray-300">{{ u.email }}</p>
                </div>
                <div class="flex gap-2">
                  <button
                    type="button"
                    class="px-2 py-1 w-[100px] bg-green-800 rounded"
                    (click)="approveMember(u)"
                  >
                    Approve
                  </button>
                </div>
              </div>
            </div>
            } @else {
            <p class="text-gray-300 p-4">No requests found.</p>
            } } @default {
            <p class="text-red-400 p-4">Error occurred.</p>
            } }
          </div>

          <div class="w-[400px] h-[62vh] bg-main rounded-2xl">
            <div
              class="mb-1 text-sm font-medium text-white flex w-full h-[40px]"
            >
              <button type="button" class="w-full rounded-tl-2xl bg-main">
                Current members
              </button>
            </div>
            @if (new_user_array.length > 0) {
            <div class="space-y-3 w-[365px] h-[56vh] overflow-auto m-auto">
              <div
                *ngFor="let u of new_user_array"
                class="flex items-center justify-between p-3 rounded-lg bg-main/70 shadow"
              >
                <div>
                  <p class="font-semibold">
                    {{ u.name }},
                    <span class="font-normal text-sm text-white/70">{{
                      u.username
                    }}</span>
                  </p>
                  <p class="text-sm text-gray-300">{{ u.email }}</p>
                </div>
                <div class="flex gap-2">
                  <button
                    type="button"
                    class="px-2 py-1 w-[100px] bg-red-800 rounded"
                    (click)="removeMember(u)"
                  >
                    Remove
                  </button>
                </div>
              </div>
            </div>
            } @else {
            <p class="text-gray-300">No users found.</p>
            }
          </div>
        </div>

        <!-- Save -->
        <div class="w-full flex">
          @if(create_new) {
          <div class="w-full flex justify-center">
            <button
              type="submit"
              class="w-2xs py-3 rounded-lg text-white bg-main border border-gray-300 hover:shadow-lg hover:bg-secondary-hover"
            >
              Create
            </button>
          </div>
          } @else {
          <div class="w-full flex justify-center">
            <button
              type="submit"
              class="w-2xs py-3 rounded-lg text-white bg-red-900 border border-gray-300 hover:shadow-lg hover:bg-red-800"
            >
              Delete Group
            </button>
          </div>
          <div class="w-full flex justify-center">
            <button
              type="submit"
              class="w-2xs py-3 rounded-lg text-white bg-main border border-gray-300 hover:shadow-lg hover:bg-secondary-hover"
            >
              Save Changes
            </button>
          </div>
          }
        </div>
      </form>
    </div>
  </div>
</div>
